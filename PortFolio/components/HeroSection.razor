@using System.Net.Http
@inject ToastService ToastService
@inject DownloadService DownloadService
@inject HttpClient Http

<section class="reveal is-in section-opt pb-3">
    <div class="hero manga-panel halftone gpu">
        <div class="hero__grid">

            <!-- LEFT: Intro -->
            <div class="hero__left">
                <div class="hero__meta">
                    @if (!string.IsNullOrWhiteSpace(BadgeText))
                    {
                        <span class="stamp anim-stamp">@BadgeText</span>
                    }
                    @if (!string.IsNullOrWhiteSpace(Location))
                    {
                        <span class="hero__location ink-dim">@Location</span>
                    }
                </div>

                <h1 class="ink-title hero__title">
                    @Title
                </h1>

                @if (!string.IsNullOrWhiteSpace(Subtitle))
                {
                    <div class="speech-bubble hero__subtitle">
                        <span class="brush-underline">@Subtitle</span>
                    </div>
                }

                @if (!string.IsNullOrWhiteSpace(Description))
                {
                    <p class="ink-muted hero__desc">
                        @Description
                    </p>
                }

                <!-- CTAs -->
                <div class="hero__ctas">
                    <InkLink Href="@PrimaryHref" Class="ink-btn ink-btn--solid gpu">
                        <span class="ink-btn__text">@PrimaryText</span>
                        <span aria-hidden="true" class="ink-btn__glyph">→</span>
                    </InkLink>

                    <InkLink Href="@SecondaryHref" Class="ink-btn ink-btn--ghost gpu">
                        <span class="ink-btn__text">@SecondaryText</span>
                        <span aria-hidden="true" class="ink-btn__glyph">✦</span>
                    </InkLink>

                    @if (!string.IsNullOrWhiteSpace(CvUrl))
                    {
                        <Button IsAsync="true"
                                Icon="fa-solid fa-download"
                                Text="@CvButtonText"
                                OnClickWithoutRender="DownloadCvAsync" />
                    }
                </div>

                @if (StacksText?.Count > 0)
                {
                    <div class="hero__tags" aria-label="Stacks">
                        @foreach (var s in StacksText)
                        {
                            <span class="hero__tag ink-dim">@s</span>
                        }
                    </div>
                }
            </div>

            <!-- RIGHT: Animated horizontal stacks -->
            <div class="hero__right">
                <div class="manga-frame hatch gpu hero__stackFrame">
                    <div class="hero__stackHeader">
                        <div>
                            <div class="ink-title hero__stackTitle">@StacksTitle</div>
                            @if (!string.IsNullOrWhiteSpace(StacksSubtitle))
                            {
                                <div class="ink-muted hero__stackSub">@StacksSubtitle</div>
                            }
                        </div>

                        @if (!string.IsNullOrWhiteSpace(StatusText))
                        {
                            <span class="stamp @(StatusIsAccent ? "" : "stamp--ink")">@StatusText</span>
                        }
                    </div>

                    @if (StackItems?.Count > 0)
                    {
                        <div class="hero__stackBody">
                            <div class="stack-marquee" aria-label="Stacks">
                                <div class="stack-track gpu">
                                    <div class="stack-seq" role="list">
                                        @for (var i = 0; i < 2; i++)
                                        {
                                            @foreach (var item in StackItems)
                                            {
                                                <div class="stack-chip" role="listitem" title="@item.Name">
                                                    <img class="stack-icon" src="@item.ImageUrl" alt="@item.Name" loading="lazy" />
                                                </div>
                                            }
                                        }
                                    </div>
                                    
                                    <div class="stack-seq" role="list">
                                        @for (var i = 0; i < 2; i++)
                                        {
                                            @foreach (var item in StackItems)
                                            {
                                                <div class="stack-chip" role="listitem" title="@item.Name">
                                                    <img class="stack-icon" src="@item.ImageUrl" alt="@item.Name" loading="lazy" />
                                                </div>
                                            }
                                        }
                                    </div>

                                    @*<div class="stack-seq stack-seq--clone" aria-hidden="true">
                                        @for (var i = 0; i < 2; i++)
                                        {
                                            @foreach (var item in StackItems)
                                            {
                                                <div class="stack-chip" title="@item.Name">
                                                    <img class="stack-icon" src="@item.ImageUrl" alt="" loading="lazy" />
                                                </div>
                                            }
                                        }
                                    </div>*@
                                </div>
                            </div>

                            <div class="hero__stackFooter">
                                @if (!string.IsNullOrWhiteSpace(Email))
                                {
                                    <a class="hero__email" href="mailto:@Email">
                                        @Email
                                    </a>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>

        </div>
    </div>
</section>

@code {
    // ----------- Inputs -----------
    [Parameter] public string Title { get; set; } = "Votre Nom";
    [Parameter] public string Subtitle { get; set; } = "Full-stack & Mobile — .NET / Blazor / Flutter / Next.js";
    [Parameter]
    public string? Description { get; set; } =
        "Je construis des applications solides et élégantes, avec une approche DDD/CQRS et une attention particulière à l’UX.";

    [Parameter] public string? BadgeText { get; set; } = "Ink Portfolio";
    [Parameter] public string? Location { get; set; } = "Québec, Canada";

    [Parameter] public string PrimaryText { get; set; } = "Bibliothèque";
    [Parameter] public string PrimaryHref { get; set; } = "/library";
    [Parameter] public string SecondaryText { get; set; } = "Me contacter";
    [Parameter] public string SecondaryHref { get; set; } = "#contact";

    [Parameter] public string? Email { get; set; } = "lawsonisaac89@gmail.com";

    // CV
    [Parameter] public string? CvUrl { get; set; } = "/cv/cv-dev.pdf"; // mettez votre PDF dans wwwroot/cv/
    [Parameter] public string CvFileName { get; set; } = "Isaac-Lawson-CV.pdf";
    [Parameter] public string CvButtonText { get; set; } = "Download CV";

    // Status badge (optionnel)
    [Parameter] public string? StatusText { get; set; } = "Stage";
    [Parameter] public bool StatusIsAccent { get; set; } = true;

    // Stacks (images)
    public sealed record StackItem(string Name, string ImageUrl);

    [Parameter] public string StacksTitle { get; set; } = "Stacks";
    [Parameter] public string? StacksSubtitle { get; set; } = "Les technos ";

    [Parameter]
    public List<StackItem>? StackItems { get; set; } = new()
    {
        new("Visual Studio", "/assets/visualstudio-original.svg"),
        new("C#", "/assets/csharp-original.svg"),
        new(".NET", "/assets/dot-net-original.svg"),
        new(".NET Core", "/assets/dotnetcore-original.svg"),
        new("EF Core", "/assets/entityframeworkcore-original.svg"),
        new("Blazor", "/assets/blazor-original.svg"),
        new("Git", "/assets/git-original.svg"),
        new("GitHub", "/assets/github-original.svg"),
        new("GitLab", "/assets/gitlab-original.svg"),
        new("Next.js", "/assets/nextjs-original.svg"),
        new("TypeScript", "/assets/typescript-original.svg"),
        new("JavaScript", "/assets/javascript-original.svg"),
        new("TailwindCss", "/assets/tailwindcss-original.svg"),
        new("BootStrap", "/assets/bootstrap-original.svg"),
        new("Flutter", "/assets/flutter-original.svg"),
        new("Dart", "/assets/dart-original.svg"),
        new("Android", "/assets/android-original.svg"),
        new("Php", "/assets/php-original.svg"),
        new("Laravel", "/assets/laravel-original.svg"),
        new("SqlServer", "/assets/microsoftsqlserver-original.svg"),
        new("MariaDB", "/assets/mariadb-original.svg"),
        new("MySql", "/assets/mysql-original.svg"),
        new("PostgreSql", "/assets/postgresql-original.svg"),
        new("Docker", "/assets/docker-original.svg"),
        new("Arch Linux", "/assets/archlinux-original.svg"),
    };

    // Optionnel: badges texte sous le Hero
    [Parameter] public List<string>? StacksText { get; set; }

    // ----------- C# download (WASM-friendly) -----------
    private string ResolveCvUrl()
    {
        if (string.IsNullOrWhiteSpace(CvUrl))
            return "/cv/cv-dev.pdf";

        // accepte "/cv/xxx.pdf" ou "cv/xxx.pdf" ou URL absolue
        if (CvUrl.StartsWith("http://", StringComparison.OrdinalIgnoreCase) ||
            CvUrl.StartsWith("https://", StringComparison.OrdinalIgnoreCase))
            return CvUrl;

        return CvUrl.StartsWith("/") ? CvUrl : "/" + CvUrl;
    }

    private async Task DownloadCvAsync()
    {
        try
        {
            var url = ResolveCvUrl();
            await using var stream = await Http.GetStreamAsync(url);
            await DownloadService.DownloadFromStreamAsync(CvFileName, stream);
        }
        catch (Exception)
        {
            //await ToastService.Error("Erreur", ex.Message);
        }
    }
}
